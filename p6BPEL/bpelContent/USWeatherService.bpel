<!-- USWeatherService BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Sat May 18 12:00:21 CEST 2019 -->
<bpel:process name="USWeatherService"
	targetNamespace="http://www.unican.es/ss/USWeatherService"
	suppressJoinFailure="yes"
	xmlns:tns="http://www.unican.es/ss/USWeatherService"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:uszs="http://www.unican.es/ss/USZipService"
	xmlns:usws="http://ws.cdyne.com/WeatherWS/">

	<!-- Import the client XSD and WSDL -->
	<bpel:import
		namespace="http://www.unican.es/ss/USZipService" location="USZip.xsd"
		importType="http://www.w3.org/2001/XMLSchema" />
	<bpel:import namespace="http://ws.cdyne.com/WeatherWS/"
		location="weatherUSService.xsd"
		importType="http://www.w3.org/2001/XMLSchema" />

	<bpel:import location="USWeatherService.wsdl"
		namespace="http://www.unican.es/ss/USWeatherService"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="USZip.wsdl"
		namespace="http://www.unican.es/ss/USZipService"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="weatherUSService.wsdl"
		namespace="http://ws.cdyne.com/WeatherWS/"
		importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- ================================================================= -->
	<!-- PARTNERLINKS -->
	<!-- List of services participating in this BPEL process -->
	<!-- ================================================================= -->
	<bpel:partnerLinks>
		<!-- The 'client' role represents the requester of this service. -->
		<bpel:partnerLink name="client"
			partnerLinkType="tns:USWeatherServicePLT"
			myRole="USWeatherServiceProvider" />
			
		<bpel:partnerLink name="USZipPL"
			partnerLinkType="tns:USZipServicePLT" 
			partnerRole="USZipProvider" />

		<bpel:partnerLink name="WeatherUSPL"
			partnerLinkType="tns:WeatherUSServicePLT"
			partnerRole="WeatherUSServiceProvider" />
	</bpel:partnerLinks>

	<!-- ================================================================= -->
	<!-- VARIABLES -->
	<!-- List of messages and XML documents used within this BPEL process -->
	<!-- ================================================================= -->
	<bpel:variables>
		<bpel:variable name="inputTemperature"
			messageType="tns:getTemperatureRequestMsg" />
		<bpel:variable name="outputTemperature"
			messageType="tns:getTemperatureResponseMsg" />

		<bpel:variable name="inputUSZip"
			messageType="uszs:zipCodesByCity" />
		<bpel:variable name="outputUSZip"
			messageType="uszs:zipCodesByCityResponse" />

		<bpel:variable name="inputWeather"
			messageType="usws:GetCityWeatherByZIP">
		</bpel:variable>
		<bpel:variable name="outputWeather"
			messageType="usws:GetCityWeatherByZIPResponse">
		</bpel:variable>

		<bpel:variable name="inputHumidity"
			messageType="tns:getHumidityRequestMsg">
		</bpel:variable>
		<bpel:variable name="outputHumidity"
			messageType="tns:getHumidityResponseMsg">
		</bpel:variable>
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:pick name="Pick" createInstance="yes">
		<bpel:onMessage partnerLink="client"
			operation="getTemperature" portType="tns:USWeatherServiceInterface"
			variable="inputTemperature">
			<bpel:sequence name="Temperature">

				<!-- Generate reply to synchronous request -->
				<bpel:assign validate="no" name="Assign">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:zipCodesByCity
									xmlns:tns="http://www.unican.es/ss/USZipService"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<arg0>arg0</arg0>
								</tns:zipCodesByCity>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="inputUSZip" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy keepSrcElementName="no"
						ignoreMissingFromData="no">
						<bpel:from part="params" variable="inputTemperature">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:city]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="inputUSZip">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[arg0]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>


				<bpel:invoke name="InvokeUSZip" partnerLink="USZipPL"
					operation="zipCodesByCity" portType="uszs:USZipInterface"
					inputVariable="inputUSZip" outputVariable="outputUSZip" />

				<bpel:assign validate="no" name="Assign1">
					<bpel:copy ignoreMissingFromData="no">
						<bpel:from>
							<bpel:literal>
								<tns:GetCityWeatherByZIP
									xmlns:tns="http://ws.cdyne.com/WeatherWS/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:ZIP>tns:ZIP</tns:ZIP>
								</tns:GetCityWeatherByZIP>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="inputWeather" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy ignoreMissingFromData="yes"
						keepSrcElementName="no">
						<bpel:from part="parameters" variable="outputUSZip">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[return[1]]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="inputWeather">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[usws:ZIP]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				
				<bpel:invoke name="InvokeWeatherUSService" partnerLink="WeatherUSPL"
					operation="GetCityWeatherByZIP" portType="usws:WeatherSoap"
					inputVariable="inputWeather" outputVariable="outputWeather">
				</bpel:invoke>
				<bpel:assign validate="no" name="Assign2">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:getTemperaturaResponse
									xmlns:tns="http://www.unican.es/ss/USWeatherService"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:temperature>tns:temperature</tns:temperature>
								</tns:getTemperaturaResponse>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="outputTemperature" part="params"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="parameters" variable="outputWeather">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[usws:GetCityWeatherByZIPResult/usws:Temperature]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="params" variable="outputTemperature">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:temperature]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:reply name="replyOutput" partnerLink="client"
					portType="tns:USWeatherServiceInterface" operation="getTemperature"
					variable="outputTemperature" />
			</bpel:sequence>
		</bpel:onMessage>
		
		<bpel:onMessage partnerLink="client"
			operation="getHumidity" portType="tns:USWeatherServiceInterface"
			variable="inputHumidity">
			<bpel:sequence name="Humidity">

				<!-- Generate reply to synchronous request -->
				<bpel:assign name="Assign">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:zipCodesByCity
									xmlns:tns="http://www.unican.es/ss/USZipService"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<arg0>arg0</arg0>
								</tns:zipCodesByCity>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="inputUSZip" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="params" variable="inputHumidity">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:city]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="inputUSZip">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[arg0]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>

				<bpel:invoke name="InvokeUSZip" partnerLink="USZipPL"
					operation="zipCodesByCity" portType="uszs:USZipInterface"
					inputVariable="inputUSZip" outputVariable="outputUSZip" />
				<bpel:assign validate="no" name="Assign1">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:GetCityWeatherByZIP
									xmlns:tns="http://ws.cdyne.com/WeatherWS/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:ZIP>tns:ZIP</tns:ZIP>
								</tns:GetCityWeatherByZIP>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="inputWeather" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy ignoreMissingFromData="yes"
						keepSrcElementName="no">
						<bpel:from part="parameters" variable="outputUSZip">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[return[1]]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="inputWeather">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[usws:ZIP]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="InvokeWeatherUSService" partnerLink="WeatherUSPL"
					operation="GetCityWeatherByZIP" portType="usws:WeatherSoap"
					inputVariable="inputWeather" outputVariable="outputWeather">
				</bpel:invoke>
				<bpel:assign validate="no" name="Assign2">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:getHumedadResponse
									xmlns:tns="http://www.unican.es/ss/USWeatherService"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:humidity>tns:humidity</tns:humidity>
								</tns:getHumedadResponse>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="outputHumidity" part="params"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="parameters" variable="outputWeather">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[usws:GetCityWeatherByZIPResult/usws:RelativeHumidity]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="params" variable="outputHumidity">
							<bpel:query
								queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[tns:humidity]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:reply name="replyOutput" partnerLink="client"
					portType="tns:USWeatherServiceInterface" operation="getHumidity"
					variable="outputHumidity" />
			</bpel:sequence>
		</bpel:onMessage>
	</bpel:pick>
</bpel:process>